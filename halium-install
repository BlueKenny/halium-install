#!/bin/bash

# Plase make sure you have qemu-user-static, qemu-system-arm, sudo and simg2img installed before running this script!

function spinner() {
	local pid=$1
	local delay=0.75
	local spinstr='|/-\'
	while [ "$(ps a | awk '{print $1}' | grep $pid)" ]; do
		local temp=${spinstr#?}
		printf " [%c]  " "$spinstr"
		local spinstr=$temp${spinstr%"$temp"}
		sleep $delay
		printf "\b\b\b\b\b\b"
	done
	printf "\b\b\b\b"
}

function convert_rootfs() {
	dd if=/dev/zero of=rootfs.img seek=500K bs=4096 count=0
	sudo mkfs.ext4 -F rootfs.img
	mkdir rootfs
	sudo mount rootfs.img rootfs
	sudo tar -xf $ROOTFS_TAR -C rootfs
}

function convert_androidimage() {
	simg2img $AND_IMAGE system.img
	sudo resize2fs -M system.img
}

function setup_ssh() {
	sudo cp $(which qemu-arm-static) rootfs/usr/bin
	
	sudo chroot rootfs passwd root
	sudo LANG=C chroot rootfs dpkg-reconfigure dropbear-run
	
	sudo rm rootfs/usr/bin/qemu-arm-static
}

function unmount() {
	sudo umount rootfs
}

function flash() {
	adb push system.img /data/system.img
	adb push rootfs.img /data/rootfs.img
}

function clean() {
	# Delete created files from last install
	sudo rm rootfs -rf
	
	sudo rm rootfs.img
	sudo rm system.img
}

export ROOTFS_TAR=$1
export AND_IMAGE=$2

echo "Debug: Chosen rootfs is $ROOTFS_TAR"
echo "Debug: Chosen android image is $AND_IMAGE"
echo

echo "I: Writing rootfs into mountable image"
convert_rootfs &> /dev/null & spinner $!

echo "I: Writing android image into mountable image"
convert_androidimage &> /dev/null & spinner $!

echo "I: Setting up SSH server"
setup_ssh

echo "I: Unmounting images"
unmount &> /dev/null & spinner $!

echo "I: Pushing rootfs and android image to /data via ADB"
flash

echo "I: Cleaning up host"
clean & spinner $!
